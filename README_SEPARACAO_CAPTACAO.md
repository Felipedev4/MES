# Sistema MES - Separa√ß√£o da Capta√ß√£o de Dados do CLP

## üìñ Vis√£o Geral

Este documento descreve a implementa√ß√£o completa da separa√ß√£o da capta√ß√£o de dados do CLP do backend normal, conforme solicitado. A solu√ß√£o implementa:

‚úÖ **Data Collector Service separado** rodando no Raspberry Pi 5  
‚úÖ **Acesso a IPs cadastrados no banco de dados**  
‚úÖ **Inser√ß√£o autom√°tica de registros na tabela plc_data**  
‚úÖ **Verifica√ß√£o de status de ordem de produ√ß√£o**  
‚úÖ **Envio de apontamentos quando ordem estiver ativa**  
‚úÖ **Cadastros de empresa, tipo de atividades, defeitos, tipos de refer√™ncia e setor**  
‚úÖ **Consumo de informa√ß√µes de IP e porta do banco de dados**  

---

## üèóÔ∏è Arquitetura Implementada

### Componentes Principais

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Frontend (React - Browser)                         ‚îÇ
‚îÇ  Dashboard | Produ√ß√£o | Cadastros | Empresas | Setores | ...         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚îÇ REST API + WebSocket
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ               Backend API (Servidor Principal)                        ‚îÇ
‚îÇ  Auth | CRUD | Dashboard | Configura√ß√µes                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚îÇ PostgreSQL
                 ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                 ‚îÇPostgreSQL ‚îÇ
                 ‚îÇ Database  ‚îÇ
                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ        Data Collector Service (Raspberry Pi 5)                        ‚îÇ
‚îÇ  PlcPoolManager | PlcConnection | ProductionMonitor                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚îÇ Modbus TCP
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚îå‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îê
          ‚îÇ CLP 1 ‚îÇ         ‚îÇ CLP 2 ‚îÇ
          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Separa√ß√£o de Responsabilidades

| Componente | Responsabilidade | Localiza√ß√£o |
|------------|------------------|-------------|
| **Frontend** | Interface do usu√°rio, cadastros | Servidor Web |
| **Backend API** | CRUD, autentica√ß√£o, regras de neg√≥cio | Servidor Principal |
| **Data Collector** | Comunica√ß√£o com CLPs, polling, apontamentos | Raspberry Pi 5 |
| **Database** | Armazenamento centralizado | Servidor DB |

---

## üìã Respostas √†s Quest√µes Solicitadas

### 1. Como a aplica√ß√£o acessa IPs cadastrados e insere em plc_data?

**Armazenamento de IPs:**
```sql
-- Tabela plc_configs (criada)
CREATE TABLE plc_configs (
    id SERIAL PRIMARY KEY,
    name VARCHAR(200),
    host VARCHAR(50),        -- IP do CLP
    port INTEGER DEFAULT 502, -- Porta Modbus
    unit_id INTEGER,
    polling_interval INTEGER,
    sector_id INTEGER,
    active BOOLEAN
);

-- Tabela plc_registers (criada)
CREATE TABLE plc_registers (
    id SERIAL PRIMARY KEY,
    plc_config_id INTEGER,
    register_name VARCHAR(50),     -- Ex: D33
    register_address INTEGER,      -- Ex: 33
    enabled BOOLEAN
);
```

**Acesso e Inser√ß√£o:**
```typescript
// PlcPoolManager.ts
// 1. Carrega configura√ß√µes ativas do banco
const configs = await prisma.plcConfig.findMany({
  where: { active: true },
  include: { registers: { where: { enabled: true } } }
});

// 2. Para cada configura√ß√£o, cria conex√£o Modbus
configs.forEach(config => {
  const connection = new PlcConnection({
    host: config.host,    // IP do banco
    port: config.port,    // Porta do banco
    registers: config.registers
  });
  connection.connect();
});

// 3. Faz polling e insere em plc_data
await prisma.plcData.create({
  data: {
    plcRegisterId: register.id,
    registerAddress: register.registerAddress,
    registerName: register.registerName,
    value: value,
    connected: true,
    timestamp: new Date()
  }
});
```

### 2. Como verifica status da ordem e envia apontamentos?

**Verifica√ß√£o de Status:**
```typescript
// ProductionMonitor.ts
const activeOrders = await prisma.productionOrder.findMany({
  where: {
    status: 'IN_PROGRESS',  // Apenas ordens ativas
    sectorId: sectorId      // Do mesmo setor do CLP
  }
});
```

**Envio de Apontamentos:**
```typescript
// Quando h√° mudan√ßa no registro E h√° ordem ativa
if (increment > 0 && activeOrders.length > 0) {
  // Cria apontamento autom√°tico
  await prisma.productionAppointment.create({
    data: {
      productionOrderId: order.id,
      userId: systemUser.id,
      quantity: increment,
      automatic: true,
      clpCounterValue: newValue
    }
  });

  // Atualiza quantidade produzida
  await prisma.productionOrder.update({
    where: { id: order.id },
    data: {
      producedQuantity: { increment: increment },
      // Se atingiu meta, marca como COMPLETED
      ...(newQuantity >= order.plannedQuantity && {
        status: 'COMPLETED',
        endDate: new Date()
      })
    }
  });
}
```

### 3. Cadastros Criados

#### a) Empresa (Company)
```typescript
interface Company {
  code: string;        // C√≥digo √∫nico
  name: string;        // Raz√£o social
  tradeName?: string;  // Nome fantasia
  cnpj?: string;       // CNPJ
  address?: string;    // Endere√ßo
  phone?: string;      // Telefone
  email?: string;      // Email
  active: boolean;     // Status
}
```

**API Endpoints:**
- `GET /api/companies` - Listar
- `GET /api/companies/:id` - Buscar
- `POST /api/companies` - Criar
- `PUT /api/companies/:id` - Atualizar
- `DELETE /api/companies/:id` - Deletar

**Frontend:** P√°gina completa em `/companies`

#### b) Setor (Sector)
```typescript
interface Sector {
  companyId: number;   // Empresa propriet√°ria
  code: string;        // C√≥digo √∫nico
  name: string;        // Nome
  description?: string;
  active: boolean;
}
```

**Relacionamentos:**
- 1 Empresa : N Setores
- 1 Setor : N CLPs
- 1 Setor : N Ordens de Produ√ß√£o

**API Endpoints:** `/api/sectors/*`

#### c) Tipo de Atividade (ActivityType)
```typescript
interface ActivityType {
  code: string;
  name: string;
  description?: string;
  color?: string;      // C√≥digo hex para UI
  active: boolean;
}
```

**Uso:** Classificar paradas (downtimes)

**Exemplos:**
- Setup de M√°quina (#3498db)
- Troca de Molde (#e74c3c)
- Manuten√ß√£o Preventiva (#2ecc71)

**API Endpoints:** `/api/activity-types/*`

#### d) Defeito (Defect)
```typescript
interface Defect {
  code: string;
  name: string;
  description?: string;
  severity: 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL';
  active: boolean;
}
```

**Uso:** Registrar defeitos de produ√ß√£o

**API Endpoints:** `/api/defects/*`

#### e) Tipo de Refer√™ncia (ReferenceType)
```typescript
interface ReferenceType {
  code: string;
  name: string;
  description?: string;
  active: boolean;
}
```

**Uso:** Classificar itens (mat√©ria-prima, produto acabado, etc)

**API Endpoints:** `/api/reference-types/*`

### 4. Armazenamento e Consumo de IP e Porta

**Armazenamento:**
```sql
-- Exemplo de inser√ß√£o
INSERT INTO plc_configs (name, host, port, unit_id, sector_id, active)
VALUES ('CLP Linha 1', '192.168.1.10', 502, 1, 1, true);

INSERT INTO plc_registers (plc_config_id, register_name, register_address, enabled)
VALUES (1, 'D33', 33, true);
```

**Consumo pelo Data Collector:**
```typescript
// 1. Inicializa√ß√£o
const configs = await loadConfigurations();

// 2. Cria√ß√£o de conex√µes
configs.forEach(config => {
  createConnection(config.host, config.port);
});

// 3. Atualiza√ß√£o din√¢mica (a cada 30s)
setInterval(async () => {
  const latestUpdate = await checkForUpdates();
  if (hasChanges) {
    reloadConfigurations();
  }
}, 30000);
```

**Consumo pelo Backend (para testes):**
```typescript
// POST /api/plc-config/test
await modbusService.testConnection({
  host: config.host,
  port: config.port,
  unitId: config.unitId,
  timeout: 5000
});
```

### 5. Implementa√ß√£o da Capta√ß√£o de Dados

#### Componentes do Data Collector

**PlcConnection.ts** - Conex√£o individual com CLP
```typescript
class PlcConnection {
  - socket: net.Socket
  - client: ModbusClient
  - registerValues: Map<address, value>
  
  + connect(): Promise<void>
  + readRegister(address): Promise<number>
  + pollAllRegisters(): Promise<void>
  + handleDisconnect(): void
  + scheduleReconnect(): void
}
```

**PlcPoolManager.ts** - Gerencia m√∫ltiplos CLPs
```typescript
class PlcPoolManager {
  - connections: Map<id, PlcConnection>
  
  + initialize(): Promise<void>
  + loadConfigurations(): Promise<void>
  + reloadConfigurations(): Promise<void>
  + getStatus(): PoolStatus
}
```

**ProductionMonitor.ts** - Monitor de produ√ß√£o
```typescript
class ProductionMonitor {
  + handleValueChange(data): Promise<void>
  + getActiveOrders(sectorId): Promise<Order[]>
  + createAppointment(order, data): Promise<void>
}
```

#### Fluxo de Dados

```
1. Data Collector inicia
   ‚Üì
2. Carrega configs do banco (IPs + Portas + Registros)
   ‚Üì
3. Conecta aos CLPs via Modbus TCP
   ‚Üì
4. Polling peri√≥dico (padr√£o: 1000ms)
   ‚îú‚îÄ L√™ registros habilitados
   ‚îú‚îÄ Compara com valor anterior
   ‚îî‚îÄ Se mudou:
      ‚îú‚îÄ Salva em plc_data
      ‚îú‚îÄ Verifica ordens IN_PROGRESS
      ‚îî‚îÄ Se ativa e incremento > 0:
         ‚îú‚îÄ Cria ProductionAppointment
         ‚îú‚îÄ Atualiza producedQuantity
         ‚îî‚îÄ Se atingiu meta: status = COMPLETED
```

#### Tratamento de Exce√ß√µes

**Erro de Conex√£o:**
```typescript
try {
  await connection.connect();
} catch (error) {
  logger.error('Erro ao conectar', error);
  await saveErrorToDatabase(error);
  scheduleReconnect();
}
```

**Erro de Leitura:**
```typescript
try {
  const value = await readRegister(address);
} catch (error) {
  errorCount++;
  if (errorCount > 5) {
    disconnect();
    reconnect();
  }
}
```

**Erro de Banco:**
```typescript
try {
  await prisma.plcData.create({ ... });
} catch (error) {
  inMemoryBuffer.push(data);
  setTimeout(() => flushBuffer(), 60000);
}
```

### 6. Vis√£o Geral da Arquitetura

#### Estrutura de Arquivos Criados

```
data-collector/                    # ‚úÖ NOVO - Servi√ßo independente
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ index.ts                   # Entry point
‚îÇ   ‚îú‚îÄ‚îÄ config/database.ts         # Prisma Client
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PlcConnection.ts       # Conex√£o individual
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PlcPoolManager.ts      # Pool de CLPs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ProductionMonitor.ts   # Monitor de produ√ß√£o
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ HealthCheck.ts         # Health check
‚îÇ   ‚îî‚îÄ‚îÄ utils/logger.ts            # Sistema de logs
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ tsconfig.json
‚îú‚îÄ‚îÄ mes-data-collector.service     # Systemd service
‚îî‚îÄ‚îÄ README.md

backend/
‚îú‚îÄ‚îÄ prisma/schema.prisma           # ‚úÖ ATUALIZADO - Novas entidades
‚îú‚îÄ‚îÄ MIGRATION_SCRIPT.sql           # ‚úÖ NOVO - Script SQL
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ server.ts                  # ‚úÖ ATUALIZADO - Novas rotas
‚îÇ   ‚îú‚îÄ‚îÄ controllers/               # ‚úÖ 5 NOVOS
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ companyController.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sectorController.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ activityTypeController.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ defectController.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ referenceTypeController.ts
‚îÇ   ‚îú‚îÄ‚îÄ routes/                    # ‚úÖ 5 NOVOS
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ companyRoutes.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sectorRoutes.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ activityTypeRoutes.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ defectRoutes.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ referenceTypeRoutes.ts
‚îÇ   ‚îî‚îÄ‚îÄ validators/                # ‚úÖ 5 NOVOS
‚îÇ       ‚îú‚îÄ‚îÄ companyValidator.ts
‚îÇ       ‚îú‚îÄ‚îÄ sectorValidator.ts
‚îÇ       ‚îú‚îÄ‚îÄ activityTypeValidator.ts
‚îÇ       ‚îú‚îÄ‚îÄ defectValidator.ts
‚îÇ       ‚îî‚îÄ‚îÄ referenceTypeValidator.ts

frontend/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ App.tsx                    # ‚úÖ ATUALIZADO - Novas rotas
‚îÇ   ‚îú‚îÄ‚îÄ components/Layout/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ MenuItems.tsx          # ‚úÖ ATUALIZADO - Novos itens
‚îÇ   ‚îî‚îÄ‚îÄ pages/
‚îÇ       ‚îî‚îÄ‚îÄ Companies.tsx          # ‚úÖ NOVO - P√°gina de exemplo

ARCHITECTURE_PROPOSAL.md            # ‚úÖ NOVO - Arquitetura detalhada
IMPLEMENTATION_SUMMARY.md           # ‚úÖ NOVO - Resumo implementa√ß√£o
DEPLOYMENT_GUIDE.md                 # ‚úÖ NOVO - Guia de deploy
README_SEPARACAO_CAPTACAO.md        # ‚úÖ NOVO - Este arquivo
```

#### Banco de Dados - Novas Entidades

```
companies (empresas)
‚îú‚îÄ‚îÄ id, code, name, tradeName, cnpj
‚îú‚îÄ‚îÄ address, phone, email, active
‚îî‚îÄ‚îÄ 1:N sectors, production_orders

sectors (setores)
‚îú‚îÄ‚îÄ id, company_id, code, name
‚îú‚îÄ‚îÄ description, active
‚îî‚îÄ‚îÄ 1:N plc_configs, production_orders

activity_types (tipos de atividade)
‚îú‚îÄ‚îÄ id, code, name, description
‚îú‚îÄ‚îÄ color, active
‚îî‚îÄ‚îÄ 1:N downtimes

defects (defeitos)
‚îú‚îÄ‚îÄ id, code, name, description
‚îú‚îÄ‚îÄ severity (LOW|MEDIUM|HIGH|CRITICAL)
‚îú‚îÄ‚îÄ active
‚îî‚îÄ‚îÄ 1:N production_defects

reference_types (tipos de refer√™ncia)
‚îú‚îÄ‚îÄ id, code, name, description
‚îú‚îÄ‚îÄ active
‚îî‚îÄ‚îÄ 1:N items

production_defects (defeitos de produ√ß√£o)
‚îú‚îÄ‚îÄ id, production_order_id, defect_id
‚îú‚îÄ‚îÄ quantity, timestamp, notes
‚îî‚îÄ‚îÄ N:1 production_order, defect
```

---

## üöÄ Como Executar

### 1. Migra√ß√£o do Banco de Dados

```bash
# Op√ß√£o A: Script SQL
psql -U postgres -d mes_db -f backend/MIGRATION_SCRIPT.sql

# Op√ß√£o B: Prisma Migrate
cd backend
npx prisma migrate dev --name add_new_entities
```

### 2. Backend

```bash
cd backend
npm install
npx prisma generate
npm run dev
```

### 3. Frontend

```bash
cd frontend
npm install
npm start
```

### 4. Data Collector (Raspberry Pi)

```bash
cd data-collector
npm install
npx prisma generate
npm run build

# Configurar .env
cp .env.example .env
nano .env

# Iniciar
npm start

# OU como servi√ßo
sudo cp mes-data-collector.service /etc/systemd/system/
sudo systemctl enable mes-data-collector
sudo systemctl start mes-data-collector
```

---

## üìä Exemplos de Uso

### Configurar CLP via API

```javascript
POST /api/plc-config
{
  "name": "CLP Linha 1",
  "host": "192.168.1.10",
  "port": 502,
  "unitId": 1,
  "pollingInterval": 1000,
  "sectorId": 1,
  "active": true,
  "registers": [
    {
      "registerName": "D33",
      "registerAddress": 33,
      "description": "Contador de produ√ß√£o",
      "enabled": true
    }
  ]
}
```

### Criar Empresa

```javascript
POST /api/companies
{
  "code": "EMP001",
  "name": "Minha Empresa LTDA",
  "tradeName": "Minha Empresa",
  "cnpj": "12345678000190",
  "active": true
}
```

### Criar Ordem de Produ√ß√£o Ativa

```javascript
POST /api/production-orders
{
  "orderNumber": "OP-001",
  "itemId": 1,
  "sectorId": 1,
  "plannedQuantity": 1000,
  "status": "IN_PROGRESS",  // Ordem ativa
  "plannedStartDate": "2025-10-21T08:00:00Z",
  "plannedEndDate": "2025-10-21T17:00:00Z"
}
```

**Resultado:**
- CLP incrementa D33 de 0 para 10
- Data Collector detecta mudan√ßa
- Cria apontamento autom√°tico de 10 pe√ßas
- Atualiza producedQuantity da ordem para 10

---

## üîß Monitoramento

### Health Checks

```bash
# Backend
curl http://localhost:3001/health

# Data Collector
curl http://raspberry-ip:3001/health
```

### Logs

```bash
# Backend
pm2 logs mes-backend

# Data Collector
sudo journalctl -u mes-data-collector -f
```

---

## üìö Documenta√ß√£o Completa

1. **[ARCHITECTURE_PROPOSAL.md](ARCHITECTURE_PROPOSAL.md)**
   - Arquitetura detalhada
   - Diagramas de fluxo
   - Especifica√ß√µes t√©cnicas
   - Pr√≥ximos passos

2. **[IMPLEMENTATION_SUMMARY.md](IMPLEMENTATION_SUMMARY.md)**
   - Resumo da implementa√ß√£o
   - Arquivos criados
   - Endpoints da API
   - Checklist de deploy

3. **[DEPLOYMENT_GUIDE.md](DEPLOYMENT_GUIDE.md)**
   - Guia passo a passo de deploy
   - Configura√ß√£o do Raspberry Pi
   - Troubleshooting
   - Checklist final

4. **[data-collector/README.md](data-collector/README.md)**
   - Documenta√ß√£o espec√≠fica do Data Collector
   - Instala√ß√£o e configura√ß√£o
   - Exemplos de uso

---

## ‚úÖ Funcionalidades Implementadas

- [x] Data Collector Service separado
- [x] Acesso a IPs do banco de dados
- [x] Inser√ß√£o autom√°tica em plc_data
- [x] Verifica√ß√£o de status de ordem
- [x] Apontamentos autom√°ticos
- [x] Cadastro de Empresa
- [x] Cadastro de Setor
- [x] Cadastro de Tipo de Atividade
- [x] Cadastro de Defeito
- [x] Cadastro de Tipo de Refer√™ncia
- [x] Consumo de IP e porta do banco
- [x] Comunica√ß√£o Raspberry Pi ‚Üî Database
- [x] Tratamento de exce√ß√µes
- [x] Reconex√£o autom√°tica
- [x] Health checks
- [x] Sistema de logs
- [x] Documenta√ß√£o completa

---

## üéØ Benef√≠cios da Arquitetura

### 1. Separa√ß√£o de Responsabilidades
- Backend focado em API e regras de neg√≥cio
- Data Collector focado em comunica√ß√£o com CLPs
- Manuten√ß√£o e deploy independentes

### 2. Escalabilidade
- Suporte a m√∫ltiplos CLPs sem sobrecarga
- Possibilidade de m√∫ltiplos Data Collectors (1 por setor)
- Balanceamento de carga facilitado

### 3. Confiabilidade
- Falha em um CLP n√£o afeta outros
- Reconex√£o autom√°tica
- Buffer de dados em caso de falha

### 4. Flexibilidade
- Configura√ß√£o din√¢mica via banco
- Adi√ß√£o de CLPs sem c√≥digo
- Suporte a diferentes tipos de registros

### 5. Manutenibilidade
- C√≥digo organizado e modular
- Logs centralizados
- F√°cil depura√ß√£o

---

## üë• Suporte

Para d√∫vidas ou problemas:
1. Consulte a documenta√ß√£o detalhada
2. Verifique os logs do sistema
3. Use os health checks para diagn√≥stico
4. Revise o guia de troubleshooting

---

**Desenvolvido em:** 21/10/2025  
**Vers√£o:** 1.0.0  
**Status:** ‚úÖ Implementa√ß√£o Completa


