# Fluxo de Sele√ß√£o de Empresa e Vincula√ß√£o de Ordens

## üìã Descri√ß√£o

Sistema completo de multi-empresa onde colaboradores podem ter acesso a m√∫ltiplas empresas e devem selecionar uma empresa para trabalhar. Todas as ordens de produ√ß√£o, itens, moldes e outros cadastros s√£o automaticamente vinculados √† empresa selecionada.

## üîÑ Fluxo Completo de Login e Sele√ß√£o de Empresa

### 1Ô∏è‚É£ **Login Inicial**

**P√°gina**: `/login`

```typescript
// Frontend: Login.tsx
const handleLogin = async () => {
  const response = await login(email, password);
  
  if (response.requiresCompanySelection && response.companies.length > 1) {
    // Usu√°rio tem m√∫ltiplas empresas
    navigate('/select-company', { 
      state: { user, companies }
    });
  } else {
    // Usu√°rio tem apenas 1 empresa ou nenhuma
    navigate('/dashboard');
  }
};
```

**Backend**: Retorna estrutura:
```json
{
  "token": "eyJhbGciOi..." ou null,
  "user": {
    "id": 1,
    "email": "admin@mes.com",
    "name": "Admin",
    "role": "ADMIN"
  },
  "companies": [
    { "id": 1, "name": "Empresa Norte", "code": "EMP-NORTE" },
    { "id": 2, "name": "Empresa Sul", "code": "EMP-SUL" }
  ],
  "requiresCompanySelection": true
}
```

**Comportamento**:
- ‚úÖ **1 Empresa**: Token JWT gerado imediatamente com `companyId`
- ‚úÖ **M√∫ltiplas Empresas**: Token `null`, usu√°rio deve selecionar
- ‚úÖ **Sem Empresas**: Token `null`, exibir mensagem de erro

---

### 2Ô∏è‚É£ **Sele√ß√£o de Empresa** (Se m√∫ltiplas empresas)

**P√°gina**: `/select-company`

**Componente**: `SelectCompany.tsx`

**Funcionalidades**:
- Exibe lista de empresas do usu√°rio
- Pr√©-seleciona empresa padr√£o (se definida)
- Permite escolher empresa manualmente
- Bot√£o "Selecionar Empresa"

```typescript
// Frontend: SelectCompany.tsx
const handleSelectCompany = async () => {
  // Chama endpoint /auth/select-company
  await authSelectCompany(selectedCompanyId);
  
  // Redireciona para dashboard
  navigate('/dashboard');
};
```

**Backend**: Endpoint `/auth/select-company`

```typescript
// Request
POST /auth/select-company
{
  "userId": 1,
  "companyId": 1
}

// Response
{
  "token": "eyJhbGciOiJIUzI1NiIs...",
  "user": { ... },
  "company": {
    "id": 1,
    "code": "EMP-NORTE",
    "name": "Empresa Norte S.A.",
    "tradeName": "Norte Ind√∫stria"
  }
}
```

**O que acontece**:
1. Verifica se usu√°rio tem acesso √† empresa (tabela `user_companies`)
2. Atualiza `selectedCompanyId` do usu√°rio
3. **Gera novo token JWT** com `companyId` inclu√≠do
4. Retorna token e dados da empresa

---

### 3Ô∏è‚É£ **Armazenamento Local**

**LocalStorage** (ap√≥s sele√ß√£o):
```javascript
localStorage.setItem('@MES:token', token);         // JWT com companyId
localStorage.setItem('@MES:user', JSON.stringify(user));
localStorage.setItem('@MES:company', JSON.stringify(company));
```

**AuthContext** (estado global):
```typescript
{
  user: User,
  selectedCompany: Company,
  companies: Company[],
  isAuthenticated: boolean
}
```

---

### 4Ô∏è‚É£ **Indica√ß√£o Visual da Empresa Selecionada**

**Header/AppBar** (`Layout.tsx`):

Exibe chip com:
- üè¢ √çcone de empresa (BusinessIcon)
- Nome da empresa
- Cor secund√°ria
- Bordas brancas

```tsx
<Chip
  icon={<BusinessIcon />}
  label={selectedCompany.name}
  color="secondary"
  variant="outlined"
/>
```

**Vis√≠vel em**: Todas as p√°ginas do sistema (exceto login e select-company)

---

## üìä Vincula√ß√£o de Ordens de Produ√ß√£o √† Empresa

### Como Funciona

**1. Token JWT cont√©m `companyId`**:
```json
{
  "userId": 1,
  "role": "ADMIN",
  "companyId": 1  // ‚Üê Empresa selecionada
}
```

**2. Middleware extrai `companyId` do token**:

```typescript
// backend/src/middleware/companyFilter.ts
export interface AuthenticatedRequest extends Request {
  user?: {
    userId: number;
    role: string;
    companyId?: number;  // ‚Üê Extra√≠do do JWT
  };
}
```

**3. Cria√ß√£o de Ordem de Produ√ß√£o**:

```typescript
// backend/src/controllers/productionOrderController.ts
export async function createProductionOrder(req: AuthenticatedRequest, res: Response) {
  const companyId = req.user?.companyId; // ‚Üê Pega do JWT
  
  const order = await prisma.productionOrder.create({
    data: {
      orderNumber,
      itemId,
      moldId,
      companyId,  // ‚Üê Vincula √† empresa automaticamente
      plannedQuantity,
      // ...
    },
  });
}
```

**4. Filtro de Listagem**:

```typescript
// backend/src/controllers/productionOrderController.ts
export async function listProductionOrders(req: AuthenticatedRequest, res: Response) {
  const where: any = {
    ...getCompanyFilter(req, false), // ‚Üê Filtra por empresa
  };
  
  const orders = await prisma.productionOrder.findMany({ where });
}
```

---

## üîê Seguran√ßa e Isolamento de Dados

### ‚úÖ Garantias de Seguran√ßa

1. **Isolamento por Empresa**:
   - Usu√°rio de Empresa A **n√£o v√™** dados da Empresa B
   - Cada token JWT √© espec√≠fico para uma empresa
   - Filtros autom√°ticos aplicados em todas queries

2. **Valida√ß√£o de Acesso**:
   - Ao selecionar empresa, verifica se usu√°rio tem acesso
   - Tabela `user_companies` controla permiss√µes
   - Tentativa de acesso n√£o autorizado retorna erro 400

3. **Auditoria**:
   - Todas ordens t√™m `companyId` gravado
   - Rastre√°vel qual empresa criou qual ordem
   - Logs de sele√ß√£o de empresa no backend

---

## üìÅ Cadastros Vinculados √† Empresa

Os seguintes cadastros **devem** ter `companyId`:

| Cadastro | Tabela | Campo |
|----------|--------|-------|
| ‚úÖ Ordens de Produ√ß√£o | `production_orders` | `companyId` |
| ‚úÖ Itens | `items` | `companyId` |
| ‚úÖ Moldes | `molds` | `companyId` |
| ‚úÖ CLPs | `plc_configs` | `companyId` |
| ‚úÖ Setores | `sectors` | `companyId` |
| ‚úÖ Apontamentos | `production_appointments` | via `productionOrderId` |
| ‚úÖ Paradas | `downtimes` | via `productionOrderId` |

---

## üéØ Casos de Uso

### **Caso 1: Usu√°rio com 1 Empresa**

```
Login ‚Üí Token JWT gerado com companyId ‚Üí Dashboard
       (Sem sele√ß√£o, direto para sistema)
```

**Fluxo**:
1. Login em `/login`
2. Backend detecta 1 empresa apenas
3. Gera token JWT com `companyId` inclu√≠do
4. Redirect para `/dashboard`
5. Todas opera√ß√µes vinculadas automaticamente

---

### **Caso 2: Usu√°rio com M√∫ltiplas Empresas**

```
Login ‚Üí Sele√ß√£o de Empresa ‚Üí Token JWT gerado ‚Üí Dashboard
       (Obrigat√≥rio selecionar)
```

**Fluxo**:
1. Login em `/login`
2. Backend detecta 2+ empresas
3. Retorna `requiresCompanySelection: true`
4. Redirect para `/select-company`
5. Usu√°rio escolhe empresa
6. Endpoint `/auth/select-company` gera token JWT
7. Redirect para `/dashboard`
8. Todas opera√ß√µes vinculadas √† empresa escolhida

---

### **Caso 3: Trocar de Empresa**

**Op√ß√µes**:

**A) Logout e Login Novamente**:
```
Dashboard ‚Üí Logout ‚Üí Login ‚Üí Selecionar Outra Empresa
```

**B) Bot√£o "Trocar Empresa"** (Implementar):
```typescript
// Futuro: Adicionar bot√£o no header
const handleChangeCompany = () => {
  navigate('/select-company', {
    state: { user, companies }
  });
};
```

---

## üîß Implementa√ß√£o T√©cnica

### **Frontend**

**Arquivos Principais**:
- ‚úÖ `frontend/src/pages/Login.tsx` - Fluxo de login
- ‚úÖ `frontend/src/pages/SelectCompany.tsx` - Sele√ß√£o de empresa
- ‚úÖ `frontend/src/contexts/AuthContext.tsx` - Estado global
- ‚úÖ `frontend/src/services/authService.ts` - Chamadas API
- ‚úÖ `frontend/src/components/Layout/Layout.tsx` - Exibi√ß√£o da empresa

**LocalStorage**:
```javascript
'@MES:token'    ‚Üí JWT com companyId
'@MES:user'     ‚Üí Dados do usu√°rio
'@MES:company'  ‚Üí Empresa selecionada
```

---

### **Backend**

**Arquivos Principais**:
- ‚úÖ `backend/src/controllers/authController.ts` - Login e sele√ß√£o
- ‚úÖ `backend/src/middleware/companyFilter.ts` - Extra√ß√£o de companyId
- ‚úÖ `backend/src/controllers/productionOrderController.ts` - Vincula√ß√£o
- ‚úÖ `backend/src/utils/jwt.ts` - JWT com companyId

**JWT Payload**:
```typescript
interface JwtPayload {
  userId: number;
  role: string;
  companyId?: number; // ‚Üê Inclu√≠do ap√≥s sele√ß√£o
}
```

**Middleware de Empresa**:
```typescript
export function getCompanyFilter(req: AuthenticatedRequest, required = true) {
  if (req.user?.companyId) {
    return { companyId: req.user.companyId };
  }
  if (required) {
    throw new Error('Company ID required');
  }
  return {};
}
```

---

## üìä Banco de Dados

### **Tabela `user_companies`**

Controla quais empresas cada usu√°rio pode acessar:

```sql
CREATE TABLE user_companies (
  id SERIAL PRIMARY KEY,
  "userId" INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  "companyId" INTEGER NOT NULL REFERENCES companies(id) ON DELETE CASCADE,
  "isDefault" BOOLEAN DEFAULT FALSE,
  "createdAt" TIMESTAMP DEFAULT NOW(),
  "updatedAt" TIMESTAMP DEFAULT NOW(),
  UNIQUE("userId", "companyId")
);
```

**Exemplo de dados**:
```sql
-- Admin tem acesso a 2 empresas
INSERT INTO user_companies ("userId", "companyId", "isDefault")
VALUES
  (1, 1, TRUE),  -- Empresa Norte (padr√£o)
  (1, 2, FALSE); -- Empresa Sul
```

---

### **Tabela `users`**

Campo `selectedCompanyId` armazena √∫ltima empresa selecionada:

```sql
ALTER TABLE users 
ADD COLUMN "selectedCompanyId" INTEGER REFERENCES companies(id);
```

---

### **Tabelas com `companyId`**

Todas tabelas de cadastro devem ter:

```sql
ALTER TABLE production_orders ADD COLUMN "companyId" INTEGER REFERENCES companies(id);
ALTER TABLE items ADD COLUMN "companyId" INTEGER REFERENCES companies(id);
ALTER TABLE molds ADD COLUMN "companyId" INTEGER REFERENCES companies(id);
ALTER TABLE plc_configs ADD COLUMN "companyId" INTEGER REFERENCES companies(id);
ALTER TABLE sectors ADD COLUMN "companyId" INTEGER REFERENCES companies(id);
```

---

## ‚úÖ Checklist de Implementa√ß√£o

### Frontend
- [x] P√°gina de login com detec√ß√£o de m√∫ltiplas empresas
- [x] P√°gina SelectCompany para escolha
- [x] AuthContext com `selectedCompany`
- [x] LocalStorage para persistir empresa
- [x] Header exibe empresa selecionada
- [x] Redirect autom√°tico ap√≥s sele√ß√£o

### Backend
- [x] Endpoint `/auth/login` retorna empresas
- [x] Endpoint `/auth/select-company` gera token
- [x] JWT inclui `companyId`
- [x] Middleware `companyFilter` extrai `companyId`
- [x] `createProductionOrder` vincula √† empresa
- [x] `listProductionOrders` filtra por empresa
- [x] Valida√ß√£o de acesso na sele√ß√£o

### Banco de Dados
- [x] Tabela `user_companies` criada
- [x] Campo `selectedCompanyId` em `users`
- [x] Campo `companyId` em `production_orders`
- [x] Campo `companyId` em outros cadastros

---

## üé® Interface Visual

### **Header com Empresa**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ‚ò∞ MES - Sistema de Manufatura  [üè¢ Empresa Norte] Admin ‚öô  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### **P√°gina SelectCompany**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Bem-vindo(a), Admin!                       ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  Voc√™ tem acesso a m√∫ltiplas empresas.      ‚îÇ
‚îÇ  Por favor, selecione uma para continuar.   ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ Empresa: [Empresa Norte ‚ñº]         ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  [  Selecionar Empresa  ]                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üêõ Troubleshooting

### **Problema**: Ordem sendo criada sem `companyId`
**Causa**: Token JWT n√£o cont√©m `companyId`  
**Solu√ß√£o**: Verificar se usu√°rio passou pela sele√ß√£o de empresa

### **Problema**: Usu√°rio n√£o v√™ ordens criadas
**Causa**: Filtro de empresa est√° ativo  
**Solu√ß√£o**: Verificar se `companyId` do token corresponde ao das ordens

### **Problema**: M√∫ltiplas empresas mas n√£o redireciona
**Causa**: L√≥gica de redirect incorreta no Login  
**Solu√ß√£o**: Verificar `requiresCompanySelection` no response

---

## üìà Melhorias Futuras

1. **Bot√£o "Trocar Empresa"** no header
2. **Dashboard por empresa** com m√©tricas segregadas
3. **Permiss√µes espec√≠ficas** por empresa
4. **Hist√≥rico de trocas** de empresa
5. **Notifica√ß√µes** quando trocar empresa
6. **Logo da empresa** no header
7. **Tema personalizado** por empresa

---

## üìå Resumo

**Status**: ‚úÖ Implementado e Funcional  
**Vers√£o**: 1.0  
**Data**: 22/10/2024  

**Funcionalidades**:
- ‚úÖ Login com detec√ß√£o de m√∫ltiplas empresas
- ‚úÖ Sele√ß√£o de empresa obrigat√≥ria
- ‚úÖ Token JWT com `companyId`
- ‚úÖ Ordens vinculadas automaticamente
- ‚úÖ Filtro por empresa em listagens
- ‚úÖ Indica√ß√£o visual no header
- ‚úÖ Persist√™ncia no localStorage
- ‚úÖ Isolamento de dados por empresa

**Tecnologias**:
- Frontend: React, TypeScript, Material-UI, React Router
- Backend: Node.js, Express, Prisma, JWT
- Banco: PostgreSQL

**Pr√≥ximos Passos**:
1. Testar com usu√°rios reais
2. Adicionar bot√£o "Trocar Empresa"
3. Implementar relat√≥rios por empresa

